<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of fromMarginalAndRunning</title>
  <meta name="keywords" content="fromMarginalAndRunning">
  <meta name="description" content="Copyright (c) 2012-2019, Imperial College London">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="#">src</a> &gt; <a href="../index.html">lang</a> &gt; <a href="index.html">+State</a> &gt; fromMarginalAndRunning.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for src\lang\+State&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>fromMarginalAndRunning
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>Copyright (c) 2012-2019, Imperial College London</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function space = fromMarginalAndRunning(qn, ind, n, s, options) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Copyright (c) 2012-2019, Imperial College London
 All rights reserved.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function space = fromMarginalAndRunning(qn, ind, n, s, options)</a>
0002 <span class="comment">% Copyright (c) 2012-2019, Imperial College London</span>
0003 <span class="comment">% All rights reserved.</span>
0004 
0005 <span class="keyword">if</span> ~exist(<span class="string">'options'</span>,<span class="string">'var'</span>)
0006     options.force = false;
0007 <span class="keyword">end</span>
0008 <span class="keyword">if</span> isa(qn,<span class="string">'Network'</span>)
0009     qn=qn.getStruct();
0010 <span class="keyword">end</span>
0011 <span class="comment">% ind: node index</span>
0012 ist = qn.nodeToStation(ind);
0013 isf = qn.nodeToStateful(ind);
0014 
0015 <span class="comment">% generate one initial state such that the marginal queue-lengths are as in vector n</span>
0016 <span class="comment">% n(r): number of jobs at the station in class r</span>
0017 <span class="comment">% s(r): jobs of class r that are running</span>
0018 R = qn.nclasses;
0019 S = qn.nservers;
0020 K = zeros(1,R);
0021 <span class="keyword">for</span> r=1:R
0022     K(r) = length(qn.mu{ist,r});
0023 <span class="keyword">end</span>
0024 state = [];
0025 space = [];
0026 <span class="keyword">if</span> any(n&gt;qn.classcap(isf,:))
0027     <span class="keyword">return</span>
0028 <span class="keyword">end</span>
0029 <span class="keyword">if</span> (qn.nservers(ist)&gt;0 &amp;&amp; sum(s) &gt; qn.nservers(ist))
0030     <span class="keyword">return</span>
0031 <span class="keyword">end</span>
0032 <span class="comment">% generate local-state space</span>
0033 <span class="keyword">switch</span> qn.nodetype(ind)
0034     <span class="keyword">case</span> {NodeType.Queue, NodeType.Delay, NodeType.Source}
0035         <span class="keyword">switch</span> qn.sched{ist}
0036             <span class="keyword">case</span> SchedStrategy.EXT
0037                 <span class="keyword">for</span> r=1:R
0038                     init = State.spaceClosedSingle(K(r),0);
0039                     <span class="keyword">if</span> isinf(qn.njobs(r))
0040                         <span class="keyword">if</span> isnan(qn.rates(ist,r))
0041                             init(1) = 0; <span class="comment">% class is not processed at this source</span>
0042                         <span class="keyword">else</span>
0043                             init(1) = 1;
0044                         <span class="keyword">end</span>
0045                     <span class="keyword">end</span>
0046                     state = State.decorate(state,init);
0047                 <span class="keyword">end</span>
0048                 space = State.decorate(space,state);
0049                 space = [Inf*ones(size(space,1),1),space];
0050             <span class="keyword">case</span> {SchedStrategy.INF, SchedStrategy.PS, SchedStrategy.DPS, SchedStrategy.GPS}
0051                 <span class="comment">% in these policies we only track the jobs in the servers</span>
0052                 <span class="keyword">for</span> r=1:R
0053                     init = State.spaceClosedSingle(K(r),n(r));
0054                     state = State.decorate(state,init);
0055                 <span class="keyword">end</span>
0056                 space = State.decorate(space,state);
0057             <span class="keyword">case</span> {SchedStrategy.RAND, SchedStrategy.LEPT, SchedStrategy.SEPT}
0058                 <span class="comment">% in these policies we track an un-ordered buffer and</span>
0059                 <span class="comment">% the jobs in the servers</span>
0060                 <span class="comment">% build list of job classes in the node, with repetition</span>
0061                 <span class="keyword">if</span> sum(n) &lt;= S(ist)
0062                     <span class="keyword">for</span> r=1:R
0063                         init = State.spaceClosedSingle(K(r),n(r));
0064                         state = State.decorate(state,init);
0065                     <span class="keyword">end</span>
0066                     space = State.decorate(space,[zeros(size(state,1),R),state]);
0067                 <span class="keyword">else</span>
0068                     <span class="comment">%            si = multichoosecon(n,S(i)); % jobs of class r that are running</span>
0069                     si = s;
0070                     mi_buf = repmat(n,size(si,1),1) - si; <span class="comment">% jobs of class r in buffer</span>
0071                     <span class="keyword">for</span> k=1:size(si,1)
0072                         <span class="comment">% determine number of classes r jobs running in phase j</span>
0073                         kstate=[];
0074                         <span class="keyword">for</span> r=1:R
0075                             init = State.spaceClosedSingle(K(r),si(k,r));
0076                             kstate = State.decorate(kstate,init);
0077                         <span class="keyword">end</span>
0078                         state = [repmat(mi_buf(k,:),size(kstate,1),1), kstate];
0079                         space = [space; state];
0080                     <span class="keyword">end</span>
0081                 <span class="keyword">end</span>
0082             <span class="keyword">case</span> {SchedStrategy.FCFS, SchedStrategy.HOL, SchedStrategy.LCFS}
0083                 sizeEstimator = multinomialln(n-s);
0084                 <span class="keyword">if</span> sizeEstimator &gt; 2
0085                     <span class="keyword">if</span> ~isfield(options,<span class="string">'force'</span>) || options.force == false
0086                         error(sprintf(<span class="string">'State space size is very large: 1e%d states. Stopping execution. Set options.force=true to bypass this control.\n'</span>,round(sizeEstimator/log(10))));
0087                     <span class="keyword">end</span>
0088                 <span class="keyword">end</span>
0089                 <span class="keyword">if</span> sum(n) == 0
0090                     space = zeros(1,1+sum(K));
0091                     <span class="keyword">return</span>
0092                 <span class="keyword">end</span>
0093                 <span class="comment">% in these policies we track an ordered buffer and</span>
0094                 <span class="comment">% the jobs in the servers</span>
0095                 
0096                 <span class="comment">% build list of job classes in the buffer, with repetition</span>
0097                 vi = [];
0098                 <span class="keyword">for</span> r=1:R
0099                     <span class="keyword">if</span> n(r)&gt;s(r)
0100                         vi=[vi, r*ones(1,n(r))];
0101                     <span class="keyword">end</span>
0102                 <span class="keyword">end</span>
0103                 
0104                 <span class="comment">% gen permutation of their positions in the fcfs buffer</span>
0105                 mi = uniqueperms(vi); <span class="comment">%unique(perms(vi),'rows) is notoriously slow</span>
0106                 <span class="keyword">if</span> isempty(mi)
0107                     mi_buf = zeros(1,max(0,sum(n)-S(ist)));
0108                     state = zeros(1,R);
0109                     state = State.decorate(state,[mi_buf,state]);
0110                 <span class="keyword">else</span>
0111                     <span class="comment">% mi_buf: class of job in buffer position i (0=empty)</span>
0112                     <span class="keyword">if</span> sum(n)&gt;sum(s)
0113                         mi_buf = mi(:,1:(sum(n)-sum(s)));
0114                     <span class="keyword">else</span> <span class="comment">% set an empty buffer</span>
0115                         mi_buf = 0;
0116                     <span class="keyword">end</span>                    
0117                     <span class="comment">% si: number of class r jobs that are running</span>
0118                     si = s;
0119                     <span class="comment">%si = unique(si,'rows');</span>
0120                     <span class="keyword">for</span> b=1:size(mi_buf,1)
0121                         <span class="keyword">for</span> k=1:size(si,1)
0122                             <span class="comment">% determine number of classs r jobs running in phase</span>
0123                             <span class="comment">% j in server state mi_srv(kjs,:) and build</span>
0124                             <span class="comment">% state</span>
0125                             kstate=[];
0126                             <span class="keyword">for</span> r=1:R
0127                                 <span class="comment">% kstate = State.decorate(kstate,State.spaceClosedSingle(K(r),si(k,r)));</span>
0128                                 init = State.spaceClosedSingle(K(r),si(k,r));
0129                                 kstate = State.decorate(kstate,init);
0130                             <span class="keyword">end</span>
0131                             state = [state; repmat(mi_buf(b,:),size(kstate,1),1), kstate];
0132                         <span class="keyword">end</span>
0133                     <span class="keyword">end</span>
0134                 <span class="keyword">end</span>
0135                 space = state;
0136             <span class="keyword">case</span> {SchedStrategy.SJF, SchedStrategy.LJF}
0137                 <span class="comment">% in these policies the state space includes continuous</span>
0138                 <span class="comment">% random variables for the service times</span>
0139                 error(<span class="string">'The scheduling policy does not admit a discrete state space.\n'</span>);
0140         <span class="keyword">end</span>
0141     <span class="keyword">case</span> NodeType.Cache
0142         <span class="keyword">switch</span> qn.sched{ist}
0143             <span class="keyword">case</span> SchedStrategy.INF
0144                 <span class="comment">% in this policies we only track the jobs in the servers</span>
0145                 <span class="keyword">for</span> r=1:R
0146                     init = State.spaceClosedSingle(K(r),n(r));
0147                     state = State.decorate(state,init);
0148                 <span class="keyword">end</span>
0149                 space = State.decorate(space,state);
0150         <span class="keyword">end</span>
0151 <span class="keyword">end</span>
0152 space = unique(space,<span class="string">'rows'</span>); <span class="comment">% do not comment, required to sort empty state as first</span>
0153 space = space(end:-1:1,:); <span class="comment">% so that states with jobs in phase 1 comes earlier</span>
0154 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Tue 19-Mar-2019 14:07:48 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>