<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of solver_fluid</title>
  <meta name="keywords" content="solver_fluid">
  <meta name="description" content="Copyright (c) 2012-2019, Imperial College London">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="#">src</a> &gt; <a href="../index.html">solvers</a> &gt; <a href="index.html">Fluid</a> &gt; solver_fluid.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for src\solvers\Fluid&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>solver_fluid
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>Copyright (c) 2012-2019, Imperial College London</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function [QN,ymean,QNt,UNt,ymean_t,t,iters,runtime] = solver_fluid(qn, options) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Copyright (c) 2012-2019, Imperial College London
 All rights reserved.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="solver_fluid_iteration.html" class="code" title="function [ymean, ymean_t, t, iter] = solver_fluid_iteration(qn, N, Lambda, Pi, P, S, ymean, ydefault, slowrate, Tstart, max_time, options)">solver_fluid_iteration</a>	Copyright (c) 2012-2019, Imperial College London</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="solver_fluid_analysis_inner.html" class="code" title="function [Qfull, Ufull, Rfull, Tfull, ymean, Qfull_t, Ufull_t, Tfull_t, ymean_t, t,iters,runtime] = solver_fluid_analysis_inner(qn, options)">solver_fluid_analysis_inner</a>	Copyright (c) 2012-2019, Imperial College London</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [QN,ymean,QNt,UNt,ymean_t,t,iters,runtime] = solver_fluid(qn, options)</a>
0002 <span class="comment">% Copyright (c) 2012-2019, Imperial College London</span>
0003 <span class="comment">% All rights reserved.</span>
0004 
0005 M = qn.nstations;    <span class="comment">%number of stations</span>
0006 K = qn.nclasses;    <span class="comment">%number of classes</span>
0007 N = qn.nclosedjobs;    <span class="comment">%population</span>
0008 Lambda = qn.mu;
0009 Pi = qn.phi;
0010 sched = qn.sched;
0011 rt = qn.rt;
0012 S = qn.nservers;
0013 NK = qn.njobs';  <span class="comment">%initial population</span>
0014 
0015 match = zeros(M,K); <span class="comment">% indicates whether a class is served at a station</span>
0016 <span class="keyword">for</span> i = 1:M
0017     <span class="keyword">for</span> k = 1:K
0018         <span class="keyword">if</span> isnan(Lambda{i,k})
0019             Lambda{i,k} = [];
0020             Pi{i,k}=[];
0021         <span class="keyword">end</span>
0022         match(i,k) = sum(rt(:, (i-1)*K+k)) &gt; 0;
0023     <span class="keyword">end</span>
0024     <span class="comment">%Set number of servers in delay station = population</span>
0025     <span class="keyword">if</span> isinf(S(i))
0026         S(i) = N;
0027     <span class="keyword">end</span>
0028 <span class="keyword">end</span>
0029 
0030 <span class="comment">%% initialization</span>
0031 max_time = Inf;
0032 Tstart = tic;
0033 
0034 <span class="comment">%phases = qn.phases;</span>
0035 phases = zeros(M,K);
0036 <span class="keyword">for</span> i = 1:M
0037     <span class="keyword">for</span> k = 1:K
0038         phases(i,k) = length(Lambda{i,k});
0039     <span class="keyword">end</span>
0040 <span class="keyword">end</span>
0041 
0042 slowrate = zeros(M,K);
0043 <span class="keyword">for</span> i = 1:M
0044     <span class="keyword">for</span> k = 1:K
0045         <span class="keyword">if</span> ~isempty(Lambda{i,k})
0046             slowrate(i,k) = min(Lambda{i,k}(:)); <span class="comment">%service completion (exit) rates in each phase</span>
0047         <span class="keyword">else</span>
0048             slowrate(i,k) = Inf;
0049         <span class="keyword">end</span>
0050     <span class="keyword">end</span>
0051 <span class="keyword">end</span>
0052 
0053 <span class="comment">%NK(isinf(NK))=1e6;</span>
0054 iters = 0;
0055 ymean = {};
0056 y0 = [];
0057 assigned = zeros(1,K); <span class="comment">%number of jobs of each class already assigned</span>
0058 <span class="keyword">for</span> i = 1:M
0059     <span class="keyword">for</span> k = 1:K
0060         <span class="keyword">if</span> match(i,k) &gt; 0 <span class="comment">% indicates whether a class is served at a station</span>
0061             <span class="keyword">if</span> isinf(NK(k))
0062                 <span class="keyword">if</span> strcmpi(sched{i},SchedStrategy.EXT)
0063                     toAssign = 1; <span class="comment">% open job pool</span>
0064                 <span class="keyword">else</span>
0065                     toAssign = 0; <span class="comment">% set to zero open jobs everywhere</span>
0066                 <span class="keyword">end</span>
0067             <span class="keyword">else</span>
0068                 toAssign = floor(NK(k)/sum(match(:,k)));
0069                 <span class="keyword">if</span> sum( match(i+1:<span class="keyword">end</span>, k) ) == 0 <span class="comment">% if this is the last station for this job class</span>
0070                     toAssign = NK(k) - assigned(k);
0071                 <span class="keyword">end</span>
0072             <span class="keyword">end</span>
0073             y0 = [y0, toAssign, zeros(1,phases(i,k)-1)]; <span class="comment">% this is just for PS</span>
0074             assigned(k) = assigned(k) + toAssign;
0075         <span class="keyword">else</span>
0076             y0 = [y0, zeros(1,phases(i,k))];
0077         <span class="keyword">end</span>
0078     <span class="keyword">end</span>
0079 <span class="keyword">end</span>
0080 
0081 <span class="keyword">if</span> isempty(options.init_sol)
0082     ymean{iters +1} = y0(:)'; <span class="comment">% average state embedded at stage change transitions out of e</span>
0083     ydefault = y0(:)'; <span class="comment">% not used in this case</span>
0084 <span class="keyword">else</span>
0085     ymean{iters +1} = options.init_sol(:)';
0086     ydefault = y0(:)'; <span class="comment">% default solution if init_sol fails</span>
0087 <span class="keyword">end</span>
0088 
0089 <span class="comment">%% solve ode</span>
0090 [ymean, ymean_t, t, iters] = <a href="solver_fluid_iteration.html" class="code" title="function [ymean, ymean_t, t, iter] = solver_fluid_iteration(qn, N, Lambda, Pi, P, S, ymean, ydefault, slowrate, Tstart, max_time, options)">solver_fluid_iteration</a>(qn, N, Lambda, Pi, rt, S, ymean, ydefault, slowrate, Tstart, max_time, options);
0091 
0092 runtime = toc(Tstart);
0093 <span class="comment">% if options.verbose &gt;= 2</span>
0094 <span class="comment">%     if iters==1</span>
0095 <span class="comment">%         fprintf(1,'Fluid analysis iteration completed in %0.6f sec [%d iteration]\n',runtime,iters);</span>
0096 <span class="comment">%     else</span>
0097 <span class="comment">%         fprintf(1,'Fluid analysis iteration completed in %0.6f sec [%d iterations]\n',runtime,iters);</span>
0098 <span class="comment">%     end</span>
0099 <span class="comment">% end</span>
0100 <span class="comment">% this part assumes PS, DPS, GPS scheduling</span>
0101 QN = zeros(M,K);
0102 QNt = cell(M,K);
0103 Qt = cell(M,1);
0104 UNt = cell(M,K);
0105 <span class="keyword">for</span> i=1:M
0106     Qt{i} = 0;
0107     <span class="keyword">for</span> k = 1:K
0108         shift = sum(sum(phases(1:i-1,:))) + sum( phases(i,1:k-1) ) + 1;
0109         QN(i,k) = sum(ymean{end}(shift:shift+phases(i,k)-1));
0110         QNt{i,k} = sum(ymean_t(:,shift:shift+phases(i,k)-1),2);
0111         Qt{i} = Qt{i} + QNt{i,k};
0112         <span class="comment">% computes queue length in each node and stage, summing the total</span>
0113         <span class="comment">% number in service and waiting in that station</span>
0114         <span class="comment">% results are weighted with the stat prob of the stage</span>
0115     <span class="keyword">end</span>
0116 <span class="keyword">end</span>
0117 
0118 <span class="keyword">for</span> i=1:M
0119     <span class="keyword">if</span> qn.nservers(i) &gt; 0
0120         <span class="keyword">for</span> k = 1:K
0121             UNt{i,k} = min(QNt{i,k} / S(i), QNt{i,k} ./ Qt{i}); <span class="comment">% if not an infinite server then this is a number between 0 and 1</span>
0122             UNt{i,k}(isnan(UNt{i,k})) = 0; <span class="comment">% fix cases where qlen is 0</span>
0123         <span class="keyword">end</span>
0124     <span class="keyword">else</span>
0125         <span class="keyword">for</span> k = 1:K
0126             UNt{i,k} = QNt{i,k};
0127         <span class="keyword">end</span>
0128     <span class="keyword">end</span>
0129 <span class="keyword">end</span>
0130 
0131 <span class="keyword">return</span>
0132 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Tue 19-Mar-2019 14:07:48 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>