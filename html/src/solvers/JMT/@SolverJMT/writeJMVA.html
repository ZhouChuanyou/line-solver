<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of writeJMVA</title>
  <meta name="keywords" content="writeJMVA">
  <meta name="description" content="Copyright (c) 2012-2019, Imperial College London">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../../index.html">Home</a> &gt;  <a href="#">src</a> &gt; <a href="../../index.html">solvers</a> &gt; <a href="../index.html">JMT</a> &gt; <a href="index.html">@SolverJMT</a> &gt; writeJMVA.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../../index.html"><img alt="<" border="0" src="../../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for src\solvers\JMT\@SolverJMT&nbsp;<img alt=">" border="0" src="../../../../right.png"></a></td></tr></table>-->

<h1>writeJMVA
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>Copyright (c) 2012-2019, Imperial College London</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>function [outputFileName] = writeJMVA(self, outputFileName) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Copyright (c) 2012-2019, Imperial College London
 All rights reserved.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="SolverJMT.html" class="code" title="">SolverJMT</a>	</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [outputFileName] = writeJMVA(self, outputFileName)</a>
0002 <span class="comment">% Copyright (c) 2012-2019, Imperial College London</span>
0003 <span class="comment">% All rights reserved.</span>
0004 
0005 <span class="keyword">if</span> ~self.model.hasProductFormSolution
0006     error(<span class="string">'JMVA requires the model to have a product-form solution.'</span>);
0007 <span class="keyword">end</span>
0008 
0009 <span class="keyword">if</span> self.model.hasClassSwitch
0010     <span class="comment">%    error('JMVA does not support class switching.');</span>
0011 <span class="keyword">end</span>
0012 
0013 <span class="keyword">if</span> isoctave
0014     mvaDoc = javaObject(<span class="string">'org.apache.xerces.dom.DocumentImpl'</span>);
0015     mvaElem = mvaDoc.createElement(<span class="string">'sim'</span>);
0016     mvaDoc.appendChild(mvaElem);
0017 <span class="keyword">else</span>
0018     mvaDoc = com.mathworks.xml.XMLUtils.createDocument(<span class="string">'model'</span>);
0019     mvaElem = mvaDoc.getDocumentElement;
0020 <span class="keyword">end</span>
0021 
0022 mvaElem.setAttribute(<span class="string">'xmlns:xsi'</span>, self.xmlnsXsi);
0023 mvaElem.setAttribute(<span class="string">'xsi:noNamespaceSchemaLocation'</span>, <span class="string">'JMTmodel.xsd'</span>);
0024 <span class="keyword">if</span> ~exist(<span class="string">'outFileName'</span>,<span class="string">'var'</span>)
0025     outputFileName = self.getJMVATempPath();
0026 <span class="keyword">end</span>
0027 
0028 qn = self.model.getStruct();
0029 
0030 algTypeElement = mvaDoc.createElement(<span class="string">'algType'</span>);
0031 <span class="keyword">switch</span> self.options.method
0032     <span class="keyword">case</span> {<span class="string">'jmva.recal'</span>}
0033         <span class="keyword">if</span> max(qn.nservers(isfinite(qn.nservers))) &gt; 1
0034             error(sprintf(<span class="string">'%s does not support multi-server stations.'</span>,self.options.method));
0035         <span class="keyword">end</span>
0036         algTypeElement.setAttribute(<span class="string">'name'</span>,<span class="string">'RECAL'</span>);
0037     <span class="keyword">case</span> {<span class="string">'jmva.comom'</span>}
0038         <span class="keyword">if</span> max(qn.nservers(isfinite(qn.nservers))) &gt; 1
0039             error(sprintf(<span class="string">'%s does not support multi-server stations.'</span>,self.options.method));
0040         <span class="keyword">end</span>
0041         algTypeElement.setAttribute(<span class="string">'name'</span>,<span class="string">'CoMoM'</span>);
0042     <span class="keyword">case</span> {<span class="string">'jmva.chow'</span>}
0043         <span class="keyword">if</span> max(qn.nservers(isfinite(qn.nservers))) &gt; 1
0044             error(sprintf(<span class="string">'%s does not support multi-server stations.'</span>,self.options.method));
0045         <span class="keyword">end</span>
0046         algTypeElement.setAttribute(<span class="string">'name'</span>,<span class="string">'Chow'</span>);
0047     <span class="keyword">case</span> {<span class="string">'jmva.bs'</span>,<span class="string">'jmva.amva'</span>}
0048         <span class="keyword">if</span> max(qn.nservers(isfinite(qn.nservers))) &gt; 1
0049             error(sprintf(<span class="string">'%s does not support multi-server stations.'</span>,self.options.method));
0050         <span class="keyword">end</span>
0051         algTypeElement.setAttribute(<span class="string">'name'</span>,<span class="string">'Bard-Schweitzer'</span>);
0052     <span class="keyword">case</span> {<span class="string">'jmva.aql'</span>}
0053         <span class="keyword">if</span> max(qn.nservers(isfinite(qn.nservers))) &gt; 1
0054             error(sprintf(<span class="string">'%s does not support multi-server stations.'</span>,self.options.method));
0055         <span class="keyword">end</span>
0056         algTypeElement.setAttribute(<span class="string">'name'</span>,<span class="string">'AQL'</span>);
0057     <span class="keyword">case</span> {<span class="string">'jmva.lin'</span>}
0058         <span class="keyword">if</span> max(qn.nservers(isfinite(qn.nservers))) &gt; 1
0059             error(sprintf(<span class="string">'%s does not support multi-server stations.'</span>,self.options.method));
0060         <span class="keyword">end</span>
0061         algTypeElement.setAttribute(<span class="string">'name'</span>,<span class="string">'Linearizer'</span>);
0062     <span class="keyword">case</span> {<span class="string">'jmva.dmlin'</span>}
0063         <span class="keyword">if</span> max(qn.nservers(isfinite(qn.nservers))) &gt; 1
0064             error(sprintf(<span class="string">'%s does not support multi-server stations.'</span>,self.options.method));
0065         <span class="keyword">end</span>
0066         algTypeElement.setAttribute(<span class="string">'name'</span>,<span class="string">'De Souza-Muntz Linearizer'</span>);
0067     <span class="keyword">case</span> {<span class="string">'jmva.ls'</span>}
0068         algTypeElement.setAttribute(<span class="string">'name'</span>,<span class="string">'Logistic Sampling'</span>);
0069     <span class="keyword">otherwise</span>
0070         algTypeElement.setAttribute(<span class="string">'name'</span>,<span class="string">'MVA'</span>);
0071 <span class="keyword">end</span>
0072 algTypeElement.setAttribute(<span class="string">'tolerance'</span>,<span class="string">'1.0E-7'</span>);
0073 algTypeElement.setAttribute(<span class="string">'maxSamples'</span>,num2str(self.options.samples));
0074 
0075 <span class="comment">%%%%%%%%%%</span>
0076 M = qn.nstations;    <span class="comment">%number of stations</span>
0077 NK = qn.njobs';  <span class="comment">% initial population per class</span>
0078 C = qn.nchains;
0079 SCV = qn.scv;
0080 
0081 <span class="comment">% determine service times</span>
0082 ST = 1./qn.rates;
0083 ST(isnan(qn.rates))=0;
0084 SCV(isnan(SCV))=1;
0085 
0086 alpha = zeros(qn.nstations,qn.nclasses);
0087 Vchain = zeros(qn.nstations,qn.nchains);
0088 <span class="keyword">for</span> c=1:qn.nchains
0089     inchain = find(qn.chains(c,:));
0090     <span class="keyword">for</span> i=1:qn.nstations
0091         Vchain(i,c) = sum(qn.visits{c}(i,inchain)) / sum(qn.visits{c}(qn.refstat(inchain(1)),inchain));
0092         <span class="keyword">for</span> k=inchain
0093             alpha(i,k) = alpha(i,k) + qn.visits{c}(i,k) / sum(qn.visits{c}(i,inchain));
0094         <span class="keyword">end</span>
0095     <span class="keyword">end</span>
0096 <span class="keyword">end</span>
0097 Vchain(~isfinite(Vchain))=0;
0098 alpha(~isfinite(alpha))=0;
0099 alpha(alpha&lt;1e-12)=0;
0100 
0101 Lchain = zeros(M,C);
0102 STchain = zeros(M,C);
0103 
0104 SCVchain = zeros(M,C);
0105 Nchain = zeros(1,C);
0106 refstatchain = zeros(C,1);
0107 <span class="keyword">for</span> c=1:qn.nchains
0108     inchain = find(qn.chains(c,:));
0109     isOpenChain = any(isinf(qn.njobs(inchain)));
0110     <span class="keyword">for</span> i=1:qn.nstations
0111         <span class="comment">% we assume that the visits in L(i,inchain) are equal to 1</span>
0112         Lchain(i,c) = Vchain(i,c) * ST(i,inchain) * alpha(i,inchain)';
0113         STchain(i,c) = ST(i,inchain) * alpha(i,inchain)';
0114         <span class="keyword">if</span> isOpenChain &amp;&amp; i == qn.refstat(inchain(1)) <span class="comment">% if this is a source ST = 1 / arrival rates</span>
0115             STchain(i,c) = 1 / sumfinite(qn.rates(i,inchain)); <span class="comment">% ignore degenerate classes with zero arrival rates</span>
0116         <span class="keyword">else</span>
0117             STchain(i,c) = ST(i,inchain) * alpha(i,inchain)';
0118         <span class="keyword">end</span>
0119         SCVchain(i,c) = SCV(i,inchain) * alpha(i,inchain)';
0120     <span class="keyword">end</span>
0121     Nchain(c) = sum(NK(inchain));
0122     refstatchain(c) = qn.refstat(inchain(1));
0123     <span class="keyword">if</span> any((qn.refstat(inchain(1))-refstatchain(c))~=0)
0124         error(sprintf(<span class="string">'Classes in chain %d have different reference station.'</span>,c));
0125     <span class="keyword">end</span>
0126 <span class="keyword">end</span>
0127 STchain(~isfinite(STchain))=0;
0128 Lchain(~isfinite(Lchain))=0;
0129 <span class="comment">%%%%%%%%%%</span>
0130 parametersElem = mvaDoc.createElement(<span class="string">'parameters'</span>);
0131 classesElem = mvaDoc.createElement(<span class="string">'classes'</span>);
0132 classesElem.setAttribute(<span class="string">'number'</span>,num2str(qn.nchains));
0133 stationsElem = mvaDoc.createElement(<span class="string">'stations'</span>);
0134 stationsElem.setAttribute(<span class="string">'number'</span>,num2str(qn.nstations - sum(self.getStruct.nodetype == NodeType.Source)));
0135 refStationsElem = mvaDoc.createElement(<span class="string">'ReferenceStation'</span>);
0136 refStationsElem.setAttribute(<span class="string">'number'</span>,num2str(qn.nchains));
0137 algParamsElem = mvaDoc.createElement(<span class="string">'algParams'</span>);
0138 
0139 sourceid = self.getStruct.nodetype == NodeType.Source;
0140 <span class="keyword">for</span> c=1:qn.nchains
0141     <span class="keyword">if</span> isfinite(sum(qn.njobs(qn.chains(c,:))))
0142         classElem = mvaDoc.createElement(<span class="string">'closedclass'</span>);
0143         classElem.setAttribute(<span class="string">'population'</span>,num2str(Nchain(c)));
0144         classElem.setAttribute(<span class="string">'name'</span>,sprintf(<span class="string">'Chain%02d'</span>,c));
0145     <span class="keyword">else</span>
0146         classElem = mvaDoc.createElement(<span class="string">'openclass'</span>);
0147         classElem.setAttribute(<span class="string">'rate'</span>,num2str(sum(qn.rates(sourceid,qn.chains(c,:)))));
0148         classElem.setAttribute(<span class="string">'name'</span>,sprintf(<span class="string">'Chain%02d'</span>,c));
0149     <span class="keyword">end</span>
0150     classesElem.appendChild(classElem);
0151 <span class="keyword">end</span>
0152 
0153 isLoadDep = false(1,qn.nstations);
0154 <span class="keyword">for</span> i=1:qn.nstations
0155     <span class="keyword">switch</span> self.getStruct.nodetype(self.getStruct.stationToNode(i))
0156         <span class="keyword">case</span> NodeType.Delay
0157             statElem = mvaDoc.createElement(<span class="string">'delaystation'</span>);
0158             statElem.setAttribute(<span class="string">'name'</span>,qn.nodenames{self.getStruct.stationToNode(i)});
0159         <span class="keyword">case</span> NodeType.Queue
0160             <span class="keyword">if</span> qn.nservers(i) == 1
0161                 isLoadDep(i) = false;
0162                 statElem = mvaDoc.createElement(<span class="string">'listation'</span>);
0163                 statElem.setAttribute(<span class="string">'name'</span>,qn.nodenames{self.getStruct.stationToNode(i)});
0164                 statElem.setAttribute(<span class="string">'servers'</span>,num2str(1));
0165             <span class="keyword">else</span>
0166                 isLoadDep(i) = true;
0167                 statElem = mvaDoc.createElement(<span class="string">'ldstation'</span>);
0168                 statElem.setAttribute(<span class="string">'name'</span>,qn.nodenames{self.getStruct.stationToNode(i)});
0169                 statElem.setAttribute(<span class="string">'servers'</span>,num2str(1));
0170             <span class="keyword">end</span>
0171         <span class="keyword">otherwise</span>
0172             <span class="keyword">continue</span>
0173     <span class="keyword">end</span>
0174     srvTimesElem = mvaDoc.createElement(<span class="string">'servicetimes'</span>);
0175     <span class="keyword">for</span> c=1:qn.nchains
0176         <span class="keyword">if</span> isLoadDep(i)
0177             statSrvTimeElem = mvaDoc.createElement(<span class="string">'servicetimes'</span>);
0178             statSrvTimeElem.setAttribute(<span class="string">'customerclass'</span>,sprintf(<span class="string">'Chain%02d'</span>,c));
0179             ldSrvString = num2str(STchain(i,c));
0180             <span class="keyword">for</span> n=2:sum(NK)
0181                 ldSrvString = sprintf(<span class="string">'%s;%s'</span>,ldSrvString,num2str(STchain(i,c)/min( n, qn.nservers(i) )));
0182             <span class="keyword">end</span>
0183             statSrvTimeElem.appendChild(mvaDoc.createTextNode(ldSrvString));
0184             srvTimesElem.appendChild(statSrvTimeElem);
0185         <span class="keyword">else</span>
0186             statSrvTimeElem = mvaDoc.createElement(<span class="string">'servicetime'</span>);
0187             statSrvTimeElem.setAttribute(<span class="string">'customerclass'</span>,sprintf(<span class="string">'Chain%02d'</span>,c));
0188             statSrvTimeElem.appendChild(mvaDoc.createTextNode(num2str(STchain(i,c))));
0189             srvTimesElem.appendChild(statSrvTimeElem);
0190         <span class="keyword">end</span>
0191     <span class="keyword">end</span>
0192     statElem.appendChild(srvTimesElem);
0193     visitsElem = mvaDoc.createElement(<span class="string">'visits'</span>);
0194     <span class="keyword">for</span> c=1:qn.nchains
0195         statVisitElem = mvaDoc.createElement(<span class="string">'visit'</span>);
0196         statVisitElem.setAttribute(<span class="string">'customerclass'</span>,sprintf(<span class="string">'Chain%02d'</span>,c));
0197         statVisitElem.appendChild(mvaDoc.createTextNode(num2str(Lchain(i,c) ./ STchain(i,c))));
0198         visitsElem.appendChild(statVisitElem);
0199     <span class="keyword">end</span>
0200     statElem.appendChild(visitsElem);
0201     
0202     stationsElem.appendChild(statElem);
0203 <span class="keyword">end</span>
0204 
0205 <span class="keyword">for</span> c=1:qn.nchains
0206     classRefElem = mvaDoc.createElement(<span class="string">'Class'</span>);
0207     classRefElem.setAttribute(<span class="string">'name'</span>,sprintf(<span class="string">'Chain%d'</span>,c));
0208     classRefElem.setAttribute(<span class="string">'refStation'</span>,qn.nodenames{qn.stationToNode(refstatchain(c))});
0209     refStationsElem.appendChild(classRefElem);
0210 <span class="keyword">end</span>
0211 
0212 compareAlgsElem = mvaDoc.createElement(<span class="string">'compareAlgs'</span>);
0213 compareAlgsElem.setAttribute(<span class="string">'value'</span>,<span class="string">'false'</span>);
0214 algParamsElem.appendChild(algTypeElement);
0215 algParamsElem.appendChild(compareAlgsElem);
0216 
0217 parametersElem.appendChild(classesElem);
0218 parametersElem.appendChild(stationsElem);
0219 parametersElem.appendChild(refStationsElem);
0220 mvaElem.appendChild(parametersElem);
0221 mvaElem.appendChild(algParamsElem);
0222 
0223 xmlwrite(outputFileName, mvaDoc);
0224 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Tue 19-Mar-2019 19:15:18 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>