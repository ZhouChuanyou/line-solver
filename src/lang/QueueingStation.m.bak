classdef QueueingStation < Station
    % Copyright (c) 2018, Imperial College London
    % All rights reserved.
    
    properties
        schedPolicy;
        schedStrategy;
        schedStrategyPar;
        serviceProcess;
    end
    
    methods
        %Constructor
        function self = QueueingStation(model, name, schedStrategy)
            self = self@Station(name);
            
            classes = model.classes;
            self.queue = Queue(classes);
            self.router = Router(classes);            
			self.schedPolicy = SchedPolicy.PR;
            self.schedStrategy = SchedStrategy.PS;
            self.serviceProcess = {};
            self.server = Server(classes);
            self.numberOfServers = 1;
            self.schedStrategyPar = zeros(1,length(model.classes));
            self.setModel(model);
            self.model.addNode(self);
            
            if exist('strategy','var')
                self.schedStrategy = schedStrategy;
                switch schedStrategy
                    case {SchedStrategy.PS, SchedStrategy.DPS,SchedStrategy.GPS}
                        self.schedPolicy = SchedPolicy.PR;
                        self.server = PSServer(classes);
                    case {SchedStrategy.FCFS, SchedStrategy.LCFS, SchedStrategy.RAND, SchedStrategy.SEPT, SchedStrategy.LEPT, SchedStrategy.SJF, SchedStrategy.LJF}
                        self.schedPolicy = SchedPolicy.NP;
                        self.server = Server(classes);
                    case SchedStrategy.INF
                        self.schedPolicy = SchedPolicy.NP;
                        self.server = Delay(classes);
                        self.numberOfServers = Inf;
                    case SchedStrategy.HOL
                        self.schedPolicy = SchedPolicy.NP;
                        self.server = Server(classes);
                    otherwise
                        error(sprintf('The specified scheduling strategy (%s) is unsupported.',schedStrategy));
                end
            end
        end
        
        function setNumServers(self, value)
            self.numberOfServers = value;
        end
        
        function self = setStrategyPar(self, class, weight)
            self.schedStrategyPar(class.index) = weight;
        end
        
        function setService(self, class, distribution, weight)
            if ~exist('weight','var')
                weight=1.0;
            end
            
            self.setStrategyPar(class, weight);
            self.serviceProcess{class.index} = distribution;
            self.server.serviceProcess{1, class.index}{2} = 'LoadIndependent';
            if distribution.isImmediate()
                self.server.serviceProcess{1, class.index}{3} = Immediate();
            else
                self.server.serviceProcess{1, class.index}{3} = distribution;
            end
            if length(self.bufferClassCapacity) < class.index
                self.bufferClassCapacity(class.index) = -1;
            end
        end
        
        function sections = getSections(self)
            sections = {self.queue, self.server, self.router};
        end
                
    end
end